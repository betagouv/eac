<journey>
  <h3 if={ this.nav && this.journeys }>
    {this.journeys.length} 
    itinéraire{ this.journeys.length > 1 ? 's' : '' } 
    disponible{ this.journeys.length > 1 ? 's' : '' } 
    depuis votre établissement
  </h3>
  <h3 if={ !(this.nav && this.journeys) }>
    Aucun itinéraire disponible depuis votre établissement
  </h3>
  <ol>
    <li each={ this.journeys }>
      <virtual if={ durations.total }>
        <img src=/images/duration.svg class=icon>
        <span class=duration>
          { this.toMinutes(durations.total) }
        </span>
      </virtual>

      <virtual if={ durations.walking }>
        · <img src=/images/walking.svg class=icon>
        <span class=duration-walk>
          { this.toMinutes(durations.walking) }
        </span>
      </virtual>
      <virtual if={ co2_emission.value }>
        <span class=co2>
          · CO<small>2</small>&nbsp;: { Math.round(co2_emission.value) } { co2_emission.unit }
        </span>
      </virtual>
      <ul>
        <virtual each={ sections }>
          <li if={ (mode == 'walking' || type == 'transfer') && from.name != to.name }>
            <img src=/images/walking.svg class=icon>
            Marcher depuis 
            <a href={ this.toOsm(coord(from)) }><strong>{ from.name }</strong></a> 
            jusqu'à 
            <a href={ this.toOsm(coord(to)) }><strong>{ to.name }</strong></a> 
            pendant 
            { this.toMinutes(duration) }
          </li>
          <li if={ type == 'on_demand_transport' || type == 'public_transport' }>
            <img src=/images/bus.svg class=icon>
            { display_informations.physical_mode || display_informations.commercial_mode } 
            <span if={ display_informations.code } class=bus-label style={ this.toStyle(display_informations) }>
              { display_informations.code }
            </span>
            depuis l'arrêt 
            <strong>{ from.name }</strong> <em>→&nbsp;{ display_informations.direction }</em>
            jusqu'à 
            <strong>{ to.name }</strong> 
            pendant 
            { this.toMinutes(duration) }
            - Réseau { display_informations.network }
          </li>
        </virtual>
      </ul>
    </li>
  </ol>
  <virtual if={ this.feed_publishers.length }>
    <h5>Sources</h5>
    <ul id=sources>
      <li each={ this.feed_publishers }>
        <a href={ this.toUrl(url) }>{ name }</a>
      </li>
    </ul>
  </virtual>

  <script>
    
    // See: http://doc.navitia.io/

    const navitiaUrl = 'https://api.navitia.io/v1'
    const osmUrl = 'https://www.openstreetmap.org/'
    const token = '038459f1-4120-47d4-950e-a18bbaca483c'
    const from = this.opts.from
    const to = this.opts.to

    this.nav = {}
    this.journeys = []
    this.feed_publishers = []
    
    this.toMinutes = (s) => Math.ceil(s/60) + "min"
    this.toStyle = (s) => `color: #${s.text_color}; background-color: #${s.color};`
    this.toUrl = (s) => s.match(/^http/) ? s : `https://${s}`
    this.coord = (o) => o[o.address ? 'address' : 'stop_point'].coord
    this.toOsm = (c) => `${osmUrl}?mlat=${c.lat}&mlon=${c.lon}#map=15/${c.lon}/${c.lng}&layers=T`
    
    this.on('mount', async () => {
      this.nav = await request(
        `${navitiaUrl}/journeys?from=${from[1]};${from[0]}&to=${to[1]};${to[0]}`, 
        { headers: { 'Authorization': token } }
      )
      this.journeys = this.nav.journeys
      this.feed_publishers = this.nav.feed_publishers
      this.update()
    }) 
  </script>

  <style scoped>
    .icon {
      margin-bottom: -5px;
      opacity: 0.5;
      height: 24px;
    }
    .bus-label {
      display: inline-block;
      border: none;
      border-radius: 3em;
      text-align: center;
      line-height: 1.2em;
      min-width: 1em;
      padding: 0.2em 0.3em; 
    }
    ul#sources {
      font-size: 1.2rem;
    }
    ul#sources > li {
      margin-bottom: 0.5rem;
    }
    a, a:visited {
      color: #1b87b6;
    }
    a:hover {
      color: #209fd6;
    }
  </style>
</journey>

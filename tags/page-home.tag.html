<page-home>
  <section class=block id=school>
    <h4>Votre établissement scolaire</h4>
    <form-school school={ this.school }></form-school>
  </section>

  <section class=block id=search if={ this.school }>
    <h2>Vous recherchez</h2>
    <form-search q={ this.q }></form-search>
  </section>

  <virtual if={ this.school && this.q }>
    <section class=block id=filters>
      <form-filters q={ this.q } filters={ this.filters }></form-filters>
    </section>

    <section if={ this.viewType == 'list' } class=block id=results>
      <button onclick={ this.setViewType } value=map>Voir les résultats sur une carte</button>
      <h2>Résultats pour « { this.q } »</h2>
      <p if={ !this.actors.length }>Aucun résultat ne correspond à cette recherche.</p>
      <actor-card each={ actor in this.actors } actor={ actor }></actor-card>
    </section>

    <section if={ this.viewType == 'map' } class=block id=map>
      <button onclick={ this.setViewType } value=list>Voir la liste des résultats</button>
      <actors-map lat-lng={ this.school.loc.coordinates.reverse() } actors={ this.actors }></actors-map>
    </section>
  </virtual>

  <script>
    /* global opts, page */
    this.q = opts.q
    this.filters = opts.filters
    this.actors = opts.actors
    this.school = opts.school
    this.viewType = 'list'

    this.filter = (event) => {
      const filters = opts.filters || {}
      const category = event.target.name
      const value = event.target.value
      if (!filters[category]) filters[category] = []
      if (event.target.checked && filters[category].indexOf(value) < 0) filters[category].push(value)
      else if (event.target.checked) filters[category].splice(filters[category].indexOf(value), 1)
      page(`/search/${this.q}/${JSON.stringify(filters)}`)
    }

    this.setViewType = (event) => {
      this.viewType = event.target.value
    }
  </script>

  <style scoped>
    :scope {
      display: grid;
      grid-template:
        'school school'
        'search search'
        'filters results'
        / minmax(auto, 40%) 1fr;
    }
    #school {
      grid-area: school;
      display: grid;
      grid-template-columns: auto 1fr;
      grid-column-gap: 2rem;
      align-items: center;
    }
    #search {
      grid-area: search;
    }
    #filters {
      grid-area: filters;
    }
    #results {
      grid-area: results;
    }
    #map {
      grid-area: results;
    }

    #school h4,
    #school input {
      margin-bottom: 0;
    }

    actor-card {
      border-bottom: 1px solid #ddd;
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
    }

    summary {
      font-weight: bold;
    }
  </style>
</page-home>

<page-actor>
  <article>
    <section class="block actor">
      <h2>{ this.actor.name }</h2>
      <nav class=tags>
        <color-tag each={ tag in this.actor.domains } label={ tag } />
      </nav>
      <p if={ this.actor.description }>{ this.actor.description }</p>

      <virtual if={ this.actor.mainPhone || this.actor.website }>
        <h4>En savoir plus</h4>
        <ul>
          <li if={ this.actor.mainPhone }><a href="tel:{ this.actor.mainPhone }">Téléphone : { this.actor.mainPhone }</a></li>
          <li if={ this.actor.website }>
            <a target=_blank href={ this.actor.website }>Visiter le site internet</a></li>
        </ul>
      </virtual>

      <virtual if={ !this.actor.description }>
        <p>Cet acteur culturel n'a pas renseigné ses informations.</p>
        <a class=button href="https://duckduckgo.com/?q={ encodeURI(`${this.actor.name} ${this.actor.city}`) }" target=_blank>Faire une recherche</a>
      </virtual>

      <x-ribbon if={ this.actor.labels } text={ this.actor.labels && this.actor.labels.join(' / ') }></x-ribbon>
    </section>

    <section id=actions if= { this.actor.actions && this.actor.actions.length }>
      <h3>Actions animée par { this.actor.name } :</h3>
      <article each={ action, i in this.actor.actions } class=block>
        <h4>{ action.name }</h4>
        <p>{ action.description.substr(0, 200) }…</p>
        <a href="/actor/{ this.actor._id }/action/{ i }" title="Voir l'action « { action.name } »">Voir cette action en détail</a>
      </article>
    </section>

    <section if={ !this.actor.actions }>
      <p>
        Les actions proposées par cet acteur sont sur demande.<br>
        Veillez à prendre contact avec cet Acteur Culturel.
      </p>
    </section>

    <aside>
      <section class=block if={ this.actor.image } id=image>
        <img src={ this.actor.image } alt="Photo de { this.actor.name }">
      </section>

      <section class=block id=contact>
        <h3 if={ this.contact }>Contacter { this.contact }</h3>
        <h3 if={ !this.contact }>Contacter le responsable EAC</h3>
        <ul>
          <li if={ this.phone }>Par téléphone : { this.phone }</li>
          <li if={ this.email }>Par email : { this.email }</li>
        </ul>
        <a if={ this.email } class=button target="_blank" href="mailto:{ this.email }?subject=À propos de { this.actor.name }&cc=loup.wolff@beta.gouv.fr&body={ encodeURIComponent(this.emailBody) }">Envoyer un email</a>
        <a if={ this.phone } class=button href="tel:{ this.phone }">Appeler</a>
        <p if={ !this.phone && !this.email }>
          Aucune information de contact n'est disponible pour cet acteur culturel.<br>
          <a class=button href="https://duckduckgo.com/?q={ encodeURI(`${this.actor.name} ${this.actor.city}`) }" target=_blank>Faire une recherche</a>
        </p>
      </section>

      <section class=block>
        <geo if={ this.actor.distance }>à { Math.ceil(this.actor.distance) }&nbsp;km</geo>
        <address if={ this.latLng }>
          <iframe width=425 height=350 frameborder=0 scrolling=no marginheight=0 marginwidth=0 src="https://www.openstreetmap.org/export/embed.html?bbox={ Number(this.latLng[1]) - 0.02 }%2C{ Number(this.latLng[0]) - 0.02 }%2C{ Number(this.latLng[1]) + 0.02 }%2C{ Number(this.latLng[0]) + 0.02 }&amp;layer=hot&amp;marker={ this.latLng[0] }%2C{ this.latLng[1] }"></iframe><br/>
          <small>
            <a href="https://www.openstreetmap.org/?mlat={ this.latLng[0] }&mlon={ this.latLng[1] }#map=15/{ this.latLng[0] }/{ this.latLng[1] }&layers=T" target=_blank>
              { this.actor.address }<br>
              { this.actor.postalCode } { this.actor.city }
            </a>
          </small>
        </address>
        <a if={ this.actor.mainPhone } href="tel:{ this.actor.mainPhone }">Tél. : { this.actor.mainPhone }</a>
      </section>
    </aside>

  <section class=edit>
    <a href=/actor/{this.opts.actorId}/edit class=button>
      Mettre à jour les informations de cet acteur
    </a>
  </section>

  </article>

  <script>
    /* global api, location */
    this.actor = {}

    this.on('mount', async () => {
      this.actor = await api(`/actors/${this.opts.actorId}`)
      this.phone = this.actor.contactPhone || this.actor.ownerPhone
      this.email = this.actor.contactEmail || this.actor.ownerEmail
      this.latLng = this.actor.loc.coordinates[0] && this.actor.loc.coordinates
      this.contact = (this.actor.contactName || this.actor.ownerName || '').replace(',', '')
      this.emailBody = `Bonjour ${this.contact},\n\n` +
        `Je vous contacte suite à ma consultation de la fiche ${location.href}.\n\n` +
        `Questions ou remarques :\n\n\n\n`
      this.update()
    })
  </script>

  <style scoped>
    @media(min-width: 800px) {
      :scope {
        display: grid;
        grid-template:
          'actor aside'
          'actions aside'
          'edit edit'
          / auto 51rem;
      }
      :scope > article {
        display: contents;
      }
      .actor {
        grid-area: actor;
      }
      #actions {
        grid-area: actions;
      }
      .edit {
        grid-area: edit;
        margin: 1rem auto;
      }
      aside {
        grid-area: aside;
      }
    }

    #actions article {
      position: relative;
      display: grid;
      margin-right: 2%;
      padding-bottom: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #ccc;
    }
    #actions article a {
      position: absolute;
      display: block;
      text-indent: -9999px;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .actor > nav {
      margin-bottom: 1rem;
    }
    .actor > p:first-of-type {
      white-space: pre-wrap;
    }

    #image {
      text-align: center;
      max-width: 100%;
    }
  </style>
</page-actor>

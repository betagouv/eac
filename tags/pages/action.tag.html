<page-action>
  <article class=block>
    <h1>{ this.action.name }</h1>
    <marked class=description if={ this.action.description } text={ this.action.description }></marked>
    <p if={ !this.action.description }>
      Contactez <a href="{ this.actor._id }">this.actor.name</a> pour en savoir plus sur ses actions d'éducation artistique et culturelle.
    </p>
    <nav if={ this.medias }>
      <a each={ media in this.medias } href={ media } target=_blank>Consulter { media.split('/').splice(-1)[0] }</a>
    </nav>

    <a if={ this.action.website } href={ this.action.website } target=_blank>Voir la page internet de cette action</a>
    <x-ribbon if={ this.actor.labels } text={ this.actor.labels && this.actor.labels.join(' / ') }></x-ribbon>
  </article>

  <section class=block>
    <h3>Informations complémentaires</h3>
    <ul>
      <li if={ this.action.schoolLevels }>Niveaux concernés : { this.action.schoolLevels.join(', ') }</li>
      <li if={ this.action.topics }>Matières concernées : { this.action.topics.join(', ') }</li>
      <li if={ this.action.capacity }>Capacité maximum de { this.action.capacity } élèves</li>
      <li if={ this.action.duration }>Durée estimée de { this.action.duration }</li>
      <li if={ this.action.cost }>Coût global approximatif de { this.action.cost }€</li>
      <virtual if={this.action.dateRange}>
        <li if={ this.action.dateRange[0] && this.action.dateRange[1] }>Disponible entre le { this.action.dateRange[0] } et le { this.action.dateRange[1] }</li>
        <li if={ this.action.dateRange[0] && !this.action.dateRange[1] }>Débute le { this.action.dateRange[0] }</li>
        <li if={ !this.action.dateRange[0] && this.action.dateRange[1] }>Effective jusqu'au { this.action.dateRange[1] }</li>
      </virtual>
    </ul>
  </section>

  <aside>
    <section class=block id=actor>
      <h3>Proposé par { this.actor.name }</h3>
      <img if={ this.actor.image } src={ this.actor.image }>
      <p if={ this.actor.description }>{ this.actor.description.substr(0, 200) }…</p>
      <a class=button href="{ this.actorUrl() }" title="Voir la fiche de { this.actor.name }">Voir sa fiche</a>
    </section>

    <actor-contact class=block actor={ this.actor } />
    <actor-map class=block actor={ this.actor } />

    <journey class=block if={ this.latLng && this.schoolLocation } from={ this.schoolLocation } to={ this.latLng }></journey>
  </aside>


  <script>
    /* globals api */
    this.action = {}
    this.actor = {}
    this.medias = []

    this.actorUrl = () => `/actor/${this.actor._id}${this.opts.schoolId && `?school=${this.opts.schoolId}` }`

    this.on('mount', async () => {
      this.action = await api(`/actions/${this.opts.id}`)
      this.actor = this.action.actor[0] || this.action.actor
      this.medias = this.action.medias ? this.action.medias.filter(m => m) : []
      // <journey> specific
      this.latLng = this.actor.loc.coordinates[0] && this.actor.loc.coordinates
      if (this.opts.schoolId) {
        const school = await schoolById(this.opts.schoolId)
        if (school.loc && school.loc.coordinates) {
          this.schoolLocation = [school.loc.coordinates[1], school.loc.coordinates[0]]
        }
      }

      this.update()
    })
  </script>

  <style scoped>
    @media(min-width: 800px) {
      :scope {
        display: grid;
        grid-template:
          "article aside"
          / auto 45rem;
      }
      article {
        grid-area: article;
      }
      aside {
        grid-area: aside;
      }
    }

    #actor {
      position: relative;
    }
    #actor img {
      display: block;
      margin: 0 auto;
    }
  </style>
</page-action>

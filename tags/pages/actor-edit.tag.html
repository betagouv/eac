<page-actor-edit>
  <section class=block>
    <h2>{ this.actor ? 'Modifier' : 'Ajouter' } un acteur culturel</h2>

    <form onsubmit={ this.submit }>

      <fieldset>
        <label for=name>Nom</label>
        <input type=text 
               id=name 
               value={ this.actor && this.actor.name } 
               required>

        <label for=description>Description</label>
        <textarea id=description 
                  value={ this.actor && this.actor.description } 
                  required></textarea>

        <label for=address>Adresse</label>
        <input type=text 
               id=address 
               name=address 
               value={ this.actor && this.address(actor) } 
               required>

        <label for=contactName>Nom du contact</label>
        <input type=text 
               id=contactName 
               name=contactName 
               value={ this.actor && this.actor.contactName } 
               required>

        <label for=contactPhone>Téléphone du contact</label>
        <input type=tel 
               id=contactPhone 
               name=contactPhone 
               value={ this.actor && this.actor.contactPhone } 
               required>

        <label for=contactEmail>Email du contact</label>
        <input type=email 
               id=contactEmail 
               name=contactEmail 
               value={ this.actor && this.actor.contactEmail } 
               required>
      </fieldset>

      <fieldset>
        <h3>Domaines</h3>
        <label each={ domain in this.domains }>
          <input type=checkbox 
                 name=domains 
                 value={ domain } 
                 checked={ this.actor && this.actor.domains.includes(domain) }> { domain }
        </label>
      </fieldset>

      <button type="submit">Enregistrer</button>

    </form>
  </section>

  <script>
    /* global request, api */

    this.address = (actor) => {
      return `${actor.address} ${actor.postalCode} ${actor.city}`
    }

    this.on('mount', async () => {
      this.actorId = this.opts.actorId
      if (this.actorId) {
        this.actor = await api(`/actors/${this.opts.actorId}`)
      } 
      this.domains = await api('/domains')
      this.update()
    })

    this.submit = async (event) => {
      event.preventDefault()

      const form = event.target

      const apiAddress = 'https://api-adresse.data.gouv.fr/search/?q='
      const addresses = await request(`${apiAddress}${form.address.value}`)
      const address = addresses.features[0]

      const loc = address.geometry
      loc.coordinates.reverse()

      const actor = await api(this.actorId ? `/actors/${this.actorId}` : '/actors', {
        method: this.actorId ? 'PUT' : 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          address: address.properties.name,
          city: address.properties.city,
          postalCode: address.properties.postcode,
          loc: loc,
          name: form.name.value,
          contactPhone: form.contactPhone.value,
          contactName: form.contactName.value,
          contactEmail: form.contactEmail.value,
          description: form.description.value,
          domains: Array.from(form.domains).filter(d => d.checked).map(d => d.value),
        })
      })

      page(`/actor/${actor._id}`)
    }
  </script>

  <style scoped>
    fieldset:last-of-type > label {
      display: inline-block;
      margin: 1rem;
    }
  </style>

</page-actor-edit>

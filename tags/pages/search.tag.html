<page-search>
  <virtual if={ this.q }>
    <section class=block id=filters>
      <search-filters filters={ this.filters } q={ this.q } school-id={ this.schoolId } actors={ this.actors } />
    </section>

    <section id=tags>
      <color-tag each={ domain in this.domains } label={ domain } />
    </section>

    <section if={ this.viewType == 'list' } id=results>
      <button onclick={ this.setViewType } value=map>Voir les résultats sur une carte</button>
      <div class=block>
        <h4>Résultats pour «&nbsp;{ this.q }&nbsp;»</h4>
        <p if={ !this.actors.length }>Aucun résultat ne correspond à cette recherche à proximité de votre établissement.</p>
      </div>
      <actor-card class=block each={ actor in this.actors } actor={ actor } school-id={ this.schoolId } />
    </section>

    <section if={ this.viewType == 'map' } id=map>
      <button onclick={ this.setViewType } value=list>Voir la liste des résultats</button>
      <actors-map class=block actors={ this.actors } school-id={ this.schoolId } />
    </section>

    <section id=extra class=block>
      <h4>Vous n'avez rien trouvé d'intéressant ?</h4>
      <p>
        Si aucun résultat ne correspond à vos attentes, d'autres sites peuvent éventuellement
      compléter votre recherche :
      </p>
      <nav>
        <a if={ !this.department || this.department == '26' } target=_blank href=http://www.ladrome.fr/nos-actions/culture/pratiques-artistiques-culturelles/actions-educatives-colleges/dispositifs-departementaux-culture-colleges>
          <img src=http://www.ladrome.fr/sites/all/themes/ladromeax/images/logo.png>
        </a>
        <a if={ !this.department || this.department in ['44', '49', '53', '72', '85'] } target=_blank href=https://www.laplateforme.net/pages/type/structures>
          <img src=https://www.laplateforme.net/app/themes/p2/dist/images/logo.svg>
        </a>
        <a if={ !this.department || this.department == '38' } target=_blank href=http://www.ac-grenoble.fr/educationartistique.isere>
          <img src=http://cache.media.education.gouv.fr/image/Academie/04/9/Logo_Grenoble_956049.png>
        </a>
        <a target=_blank href=https://www.messortiesculture.com>
          <img src=https://www.messortiesculture.com/images/logo.svg>
        </a>
      </nav>
    </section>
  </virtual>

  <script>
    /* global api, encodeURI, opts, normalizeString */
    this.q = this.opts.q
    this.schoolId = this.opts.schoolId
    try {
      this.filters = JSON.parse(decodeURI(opts.filters))
    } catch (e) {
      this.filters = {}
    }
    this.actors = []
    this.viewType = 'list'
    this.domains = this.filters.domains || []
    this.school = {}

    ;(async () => {
      let params = this.filters.domains ? `?domains=${this.domains}` : ''
      if (this.schoolId) {
        this.school = await api(`/schools/${this.schoolId}`)
        if (this.school.loc.coordinates) {
          params += (params ? '&' : '?')
          params += `from=${this.school.loc.coordinates[1]},${this.school.loc.coordinates[0]}`
        }
      }
      this.actors = await api(`/actors/search/${normalizeString(this.q)}${params}`)
      this.department = this.school.postalCode && this.school.postalCode.substr(0, 2)
      this.update()
    })()

    this.setViewType = (event) => {
      this.viewType = event.target.value
    }
  </script>

  <style scoped>
  :scope {
      display: grid;
      grid-template:
        'search search'
        'tags tags'
        'filters results'
        'filters extra'
        / minmax(auto, 35%) 1fr;
      grid-gap: 2rem;
    }
    #search {
      grid-area: search;
    }
    #tags {
      grid-area: tags;
      height: 4rem;
    }
    #filters {
      grid-area: filters;
      height: auto;
    }
    #results {
      grid-area: results;
    }
    #map {
      grid-area: results;
    }
    #extra {
      grid-area: extra;
    }
    #extra img {
      max-width: 20rem;
      max-height: 10rem;
    }
    h4 {
      margin-top: 1rem;
    }

    search-filters {
      position: sticky;
      top: 0;
    }

    input[type=search] {
      border-color: #999;
      box-shadow: 0 0 .1em #ccc;
      font-size: 1.2em;
      padding: 1em .7em;
      transition: box-shadow .3s;
    }
    input[type=search]:focus {
      box-shadow: .05em .05em .2em #bbb;
    }

    input[type=submit] {
      display: block;
      margin: 0 auto;
    }

    actor-card {
      padding-bottom: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }

    #tags .tag {
      background-color: #fff;
      box-shadow: .1rem .1rem .5rem #eee;
      border-radius: .8rem;
      border: 1px solid #e6e6e6;
      margin-right: 2rem;
    }

    #extra a {
      display: inline-block;
      width: 30%;
      padding: 2rem;
      text-align: center;
    }
  </style>
</page-search>

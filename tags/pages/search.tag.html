<page-search>
    <section class=block id=filters>
      <search-filters filters={ this.filters } q={ this.q } school-id={ this.schoolId } actors={ this.actors } />
    </section>

    <section id=tags>
      <color-tag each={ domain in this.domains } label={ domain } />
    </section>

    <section if={ this.viewType == 'list' } id=results>
      <button onclick={ this.setViewType } value=map>Voir les résultats sur une carte</button>
      <div class=block>
        <h4 if={ this.q }>Résultats pour «&nbsp;{ this.q }&nbsp;»</h4>
        <h4 if={ !this.q && this.school.name }> Résultats autour de { this.school.name } ({ this.school.city })</h4>
        <p if={ this.ready && !this.actors.length }>Aucun résultat ne correspond à cette recherche à proximité de votre établissement.</p>
      </div>
      <actor-card class=block each={ actor in this.actors } actor={ actor } school-id={ this.schoolId } />
    </section>

    <section if={ this.viewType == 'map' } id=map>
      <button onclick={ this.setViewType } value=list>Voir la liste des résultats</button>
      <actors-map class=block actors={ this.actors } school-id={ this.schoolId } />
    </section>

    <section if={ this.ready } id=extra class=block>
      <h4>Vous n'avez rien trouvé d'intéressant&nbsp;?</h4>
      <actors-externals department={ this.department }></actors-externals>
      <p>
        Vous pouvez participer à améliorer la base de données en ajoutant un acteur
        culturel&nbsp;:
      </p>
      <a href=/actor/create class=button>Ajouter un acteur culturel</a>
    </section>

  <script>
    /* global api, normalizeString */
    this.ready = false
    this.q = this.opts.q
    this.schoolId = this.opts.schoolId
    try {
      this.filters = JSON.parse(decodeURI(this.opts.filters))
    } catch (e) {
      this.filters = {}
    }
    this.actors = []
    this.viewType = 'list'
    this.domains = this.filters.domains || []
    this.school = {}

    this.on('mount', async () => {
      let params = this.filters.domains ? `?domains=${this.domains}` : ''

      if (this.schoolId) {
        this.school = await schoolById(this.schoolId)
        if (this.school.loc && this.school.loc.coordinates) {
          params += (params ? '&' : '?')
          params += `from=${this.school.loc.coordinates[1]},${this.school.loc.coordinates[0]}`
        }
      }
      let [actors, actions] = await Promise.all([
        api(`/actors/search/${normalizeString(this.q)}${params}`),
        api(`/actions/search/${normalizeString(this.q)}${params}`)
      ])
      // Todo: refactor to spread object (need https://babeljs.io/docs/en/babel-plugin-transform-object-rest-spread)
      actions = actions.filter(a => a.name).map(action => {
        action.domains = action.actor.domains
        action.distance = action.actor.distance
        action.labels = action.actor.labels
        action.department = action.actor.department
        action._id = action.actor._id
        return action
      })
      this.actors = [...actions, ...actors]
      this.department = this.school.postalCode && this.school.postalCode.substr(0, 2)
      this.ready = true
      this.update()
    })

    this.setViewType = (event) => {
      this.viewType = event.target.value
    }
  </script>

  <style scoped>
  :scope {
      display: grid;
      grid-template:
        'search search'
        'tags tags'
        'filters results'
        'filters extra'
        / minmax(auto, 35%) 1fr;
      grid-gap: 2rem;
    }
    #search {
      grid-area: search;
    }
    #tags {
      grid-area: tags;
      height: 4rem;
    }
    #filters {
      grid-area: filters;
      height: auto;
    }
    #results {
      grid-area: results;
    }
    #map {
      grid-area: results;
    }
    #extra {
      grid-area: extra;
    }

    h4 {
      margin-top: 1rem;
    }

    search-filters {
      position: sticky;
      top: 0;
    }

    input[type=search] {
      border-color: #999;
      box-shadow: 0 0 .1em #ccc;
      font-size: 1.2em;
      padding: 1em .7em;
      transition: box-shadow .3s;
    }
    input[type=search]:focus {
      box-shadow: .05em .05em .2em #bbb;
    }

    input[type=submit] {
      display: block;
      margin: 0 auto;
    }

    actor-card {
      padding-bottom: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }

    #tags .tag {
      background-color: #fff;
      box-shadow: .1rem .1rem .5rem #eee;
      border-radius: .8rem;
      border: 1px solid #e6e6e6;
      margin-right: 2rem;
    }
  </style>
</page-search>

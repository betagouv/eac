<!doctype html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href="./css/roboto.css">
<link rel=stylesheet href=./css/normalize.css>
<link rel=stylesheet href=./css/milligram.min.css>
<link rel=stylesheet href=./js/awesomplete.css>
<link rel=stylesheet href=https://unpkg.com/leaflet@1.3.1/dist/leaflet.css integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin>

<style>
body {
  background-color: #f8f8f8;
}

body > header {
  padding: .5rem !important;
}
body > header > a {
  display: grid;
  grid-template:
    ". logo title ."
    ". logo baseline ."
    / 1fr 150px auto 1fr
    ;
  color: inherit;
}
body > header > a #logo {
  grid-area: logo;
}
body > header > a h1 {
  grid-area: title;
  font-size: 2em;
  margin: .4em 0 0 0;
  align-self: end;
}
body > header > a h2 {
  grid-area: baseline;
  font-size: 1em;
  font-weight: 200;
}

.block {
  background-color: #fff;
  margin: 0 1em 1em 0;
  padding: 2em;
  box-shadow: .3em .3em .2em #eee;
}
.block h2 {
  text-align: center;
}

.loading {
  position: fixed;
  width: 300px;
  height: 300px;
  background: url(images/loading.gif) no-repeat center center;
  top: calc(50% - 150px);
  left: calc(50% - 150px);
}

.tag {
  display: inline-block;
  padding: .3rem 1rem;
  border-radius: .3rem;
  font-size: 1.1rem;
  font-style: italic;
  background: #eee;
  color: inherit;
  cursor: default;
}
.tag:not(:last-of-type) {
  margin-right: 1rem;
}
</style>


<header class=block>
  <a href=/>
    <img id=logo src=images/logo-eac.gif alt="Logo de la Plateforme EAC">
    <h1>Plateforme EAC</h1>
    <h2>L'Éducation artistique et culturelle à votre portée</h2>
  </a>
</header>

<main><div class=loading></div></main>

<script type=riot/tag src=./tags/page-home.tag.html></script>
<script type=riot/tag src=./tags/page-actor.tag.html></script>
<script type=riot/tag src=./tags/form-search.tag.html></script>
<script type=riot/tag src=./tags/form-filters.tag.html></script>
<script type=riot/tag src=./tags/form-school.tag.html></script>
<script type=riot/tag src=./tags/actor-card.tag.html></script>
<script type=riot/tag src=./tags/actors-map.tag.html></script>

<script src=./js/riot+compiler.min.js></script>
<script src=./js/utils.js></script>
<script src=./js/page.js></script>
<script src=./js/page.query.js></script>
<script src=./js/awesomplete.min.js></script>
<script src=https://unpkg.com/leaflet@1.3.1/dist/leaflet.js integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin></script>
<script>
  /* global
    fetch,
    localStorage,
    location,
    page,
    qs,
    riot,
  */
  const app = document.querySelector('main')
  const apiUrl = localStorage.getItem('apiUrl') || 'https://eac-api.herokuapp.com'
  let school = localStorage.getItem('school') && JSON.parse(localStorage.getItem('school'))

  function api (url) {
    return fetch(`${apiUrl}${url}`, {mode: 'cors'})
      .then(r => r.json())
      .catch(console.error.bind(console))
  }

  /**
  * Make query string available to ctx.
  */
  page('*', (ctx, next) => {
    const hash = location.hash
    if (hash.indexOf('?') >= 0) { ctx.query = qs.parse(hash.slice(hash.indexOf('?') + 1)) }
    next()
  })

  page('/school/:id', async ctx => {
    school = await api(`/schools/${ctx.params.id}`)
    localStorage.setItem('school', JSON.stringify(school))
    page('/')
  })

  page('/', () => {
    app.innerHTML = '<page-home></page-home>'
    riot.mount('page-home', { school })
  })

  page('/search/:query/:filters', async ctx => {
    if (!school) {
      page('/')
    }
    app.innerHTML = '<page-home></page-home>'
    const q = ctx.params.query
    const filters = JSON.parse(decodeURI(ctx.params.filters))
    let params = filters.domains ? `?domains=${filters.domains}` : ''
    if (school.loc.coordinates) {
      params += (params ? '&' : '?')
      params += `from=${school.loc.coordinates[1]},${school.loc.coordinates[0]}`
    }
    const actors = await api(`/actors/search/${q}${params}`)
    riot.mount('page-home', { filters, actors, q, school })
  })

  page('/actor/:id', async (ctx) => {
    app.innerHTML = '<page-actor></page-actor>'
    let params = ''
    if (school.loc) params = `?from=${school.loc.coordinates[1]},${school.loc.coordinates[0]}`
    const actor = await api(`/actors/${ctx.params.id}${params}`)
    riot.mount('page-actor', { actor, school })
  })

  async function init () {
    page({hashbang: true})
  }

  init()
</script>

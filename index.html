<!doctype html>
<meta charset=utf-8>
<link rel=stylesheet href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
<link rel=stylesheet href=//cdn.rawgit.com/necolas/normalize.css/master/normalize.css>
<link rel=stylesheet href=./css/milligram.min.css>

<style>
body {
  background-color: #f8f8f8;
}

#logo {
  max-height: 5em;
  float: left;
}
body > header {
  padding: .5rem !important;
}
body > header h1 {
  font-size: 2em;
  margin: .4em 0 0 0;
}
body > header h2 {
  font-size: 1em;
  font-weight: 200;
}

.block {
  background-color: #fff;
  margin: 0 1em 1em 0;
  padding: 2em;
  box-shadow: .3em .3em .2em #eee;
}
main .block h2 {
  text-align: center;
}

#home > header {
  display: flex;
}
#home > header section {
  flex: 1;
}

.cards {
  display: flex;
}

.poiCard {
  position: relative;
  border: 1px solid #ddd;
  padding: 1rem;
  width: 30%;
  margin-right: 3%;
  margin-bottom: 1rem;
}
.poiCard h3 {
  font-size: 1.2em;
  margin-bottom: 1rem;
}

.poiCard .tags,
.poiCard .tags li {
  margin-bottom: 0;
  text-align: right;
}
.poiCard .tags li {
  list-style: none;
  display: inline-block;
  font-size: 1.1rem;
  font-style: italic;
  background: #eee;
  padding: .3rem 1rem;
  border-radius: .3rem;
}
.poiCard .tags li:not(:last-of-type) {
  margin-right: 1rem;
}

#search h2 {
  text-align: center;
}
#search input[type=search] {
  border-color: #999;
  box-shadow: 0 0 .1em #ccc;
  font-size: 1.2em;
  padding: 1em .7em;
  transition: box-shadow .3s;
}
#search input[type=search]:focus {
  box-shadow: .05em .05em .2em #bbb;
}
#search input[type=submit] {
  display: block;
  margin: 0 auto;
}

#filters {
  display: flex;
  margin-top: 2rem;
}

.filters {
  flex: 1;
}
label input[type=checkbox] {
  margin-right: .8rem;
}
</style>

<header class=block>
  <img id=logo src=images/logo-eac.jpg alt="Logo de la Pleateforme EAC">
  <h1>Pleateforme EAC</h1>
  <h2>L'Éducation artistique et culturelle à votre portée</h2>
</header>

<main>
  <div class=page id=home>
    <header>
      <section class=block>
        <h2>Proche de vous</h2>
        <div class=cards id=closest-pois-list></div>
        <article>

        </article>
      </section>

      <section class=block>
        <h2>Actualité</h2>
        <div class=cards id=newest-pois-list></div>
      </section>
    </header>

    <section id=search class=block>
      <h2>Vous recherchez</h2>
      <form action=/search>
        <input type=search name=q id=q value="" required autofocus>
        <input type=submit value=Rechercher>
      <form>

      <section id=filters>
        <section class=filters>
          <h3>Type</h3>
          <label for=sortie><input type=checkbox name=type value=sortie id=sortie>Sortie</label>
          <label for=intervention><input type=checkbox name=type value=intervention id=intervention>Intervention</label>
        </section>

        <section class=filters>
          <h3>Niveau</h3>
          <label for=1er><input type=checkbox name=type value=1er id=1er>1er niveau</label>
          <label for=college><input type=checkbox name=type value=college id=college>Collège</label>
          <label for=lycee><input type=checkbox name=type value=lycee id=lycee>Lycée</label>
        </section>

        <section class=filters>
          <h3>Domaine</h3>
          <label for=danse><input type=checkbox name=type value=danse id=danse>Danse</label>
          <label for=theatre><input type=checkbox name=type value=theatre id=theatre>Theatre</label>
          <label for=sciences><input type=checkbox name=type value=sciences id=sciences>Culture scientifique et technique</label>
          <label for=plastique><input type=checkbox name=type value=plastique id=plastique>Arts plastiques</label>
        </section>

        <section class=filters>
          <h3>Compétences PEAC</h3>
          <label for=1><input type=checkbox name=type value=1 id=1>Cultiver sa sensibilité</label>
          <label for=2><input type=checkbox name=type value=2 id=2>Échanger avec un artiste</label>
          <label for=3><input type=checkbox name=type value=3 id=3>Appréhender des oeuvres</label>
        </section>
      <section>
    </section>
  </div>

  <div class=page id=search-page>
    <section class=block>
      <div>Aucun résultat n'est disponible</div>
      <a class=button href=#>Retour</a>
    </section>
  </div>
</main>

<script src=./js/fuse.min.js></script>
<script src=./js/route.min.js></script>
<script>
  const apiKey = 'a2V5VnF0SVlyN3l1U1VnTXc='
  const databaseId = 'appQXPPR2DMoc3B6N'
  var searchablePois = null
  const searchablePoisOptions = {
    keys: [{
      name: 'Nom',
      weight: 0.8
    }, {
      name: 'Type',
      weight: 0.5
    }, {
      name: 'Description',
      weight: 0.3
    }]
  }
  const db = {
    data: {},

    async load() {
      try {
        this.data = {
          schools: await this.callAirtable('Etablissements'),
          pois: await this.callAirtable('Acteurs Culturels'),
        }
      }
      catch (e) {console.error(e)}
      return this.data
    },

    callAirtable(table, options) {
      return fetch(`https://api.airtable.com/v0/${databaseId}/${table}/?view=Grid%20view`, {
        method: 'GET',
        headers: {
          Authorization: `Bearer ${atob(apiKey)}`,
        },
      })
      .then(r => r.json())
      .then(collection => collection.records.map(row => Object.assign({id: row.id, createdTime: row.createdTime}, row.fields)))
      .catch(console.error.bind(console))
    }
  }


  db.load().then(data => {
    console.info('Airtable data are downloaded.')
    document.querySelector('#closest-pois-list').innerHTML = data.pois.slice(0, 3).map(d => renderPoi(d)).join('')
    document.querySelector('#newest-pois-list').innerHTML = data.pois.sort((a, b) => a.createdTime < b.createdTime).slice(0, 3).map(d => renderPoi(d)).join('')
    searchablePois = new Fuse(data.pois, searchablePoisOptions)
  })

  function renderPoi(data) {
    return `
      <div class=poiCard>
        <h3>${data.Nom}</h3>
        <p>${data.Description.substr(0, 80)}…</p>
        <!--<address>${data['Adresse Postal']} ${data['Code Postal']}</address>-->
        <ul class=tags>
          ${data.Type.map(type => `<li>${type}</li>`).join('')}
        </ul>
      </div>`
  }

  document.querySelector('#search form').addEventListener('submit', event => {
    event.preventDefault()
    const q = event.target.q.value
    route(`/search/${q}`)
  })

  route('/', () => {
    console.debug('home page')
    document.querySelectorAll('.page').forEach(e => {e.style.display = 'none'})
    document.querySelector('.page#home').style.display = 'block'
  })
  route('/search/*', (q) => {
    document.querySelectorAll('.page').forEach(e => {e.style.display = 'none'})
    const page = document.querySelector('#search-page')
    page.style.display = 'block'
  })
  route.base('#!/')
  route.start(true)

</script>
